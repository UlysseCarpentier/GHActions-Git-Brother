name: Send Slack Notification
on:
  push:
  workflow_dispatch:

jobs:
  check_branch-name:
    name: check_branch
    runs-on: ubuntu-latest
    #Important
    outputs:
      status: ${{ job.status }}
      message: ${{ steps.status_update1.outputs.message }}

    steps:
      - name: Extract branch name
        shell: bash
        run: echo "branch=${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}" >> $GITHUB_OUTPUT
        id: extract_branch
      - run: echo "ðŸ This branch name is ${{ steps.extract_branch.outputs.branch }}."
      - name: Check branch name
        id: check-branch_name
        run: |
          if echo "${{ steps.extract_branch.outputs.branch }}" | grep -Po '^(chore|feat|fix|hotfix)/[a-zA-Z0-9-]+/(RM|GH)-\d{6}_[a-zA-Z0-9-]+$'; then
              echo "match=true" >> $GITHUB_OUTPUT
          fi
      - name: Exit Status Update
        id: status_update
        if: steps.check-branch_name.outputs.match != 'true'
        run: |
          exit 0
      - name: Exit Status Update1
        id: status_update1
        run: |
          echo "message=Salut cest le message" >> $GITHUB_OUTPUT
          exit 1

  second_job:
    name: second-job
    runs-on: ubuntu-latest
    #Important
    outputs:
      status: ${{ job.status }}
    steps:
      - name: Exit Status Update
        id: status_update1
        run: |
          exit 1


  #Important
  slack_setup:
    runs-on: ubuntu-latest
    #important
    #Uses stategy matrix to only have one depenndancy at a time
    needs: [check_branch-name, second_job]
    if: always()
    outputs:
      status: ${{steps.set_status.outputs.status}}
      slack_id: ${{steps.get_github_bio.outputs.bio}}
      message: ${{steps.set_message.outputs.message}}
    steps:
      - name: Set status
        id: set_status
        shell: bash
        #If there's at least one "failure" job, the overall status is "failure."
        #If all jobs are "success" or "skipped," the overall status is "success."
        #If there's at least one "cancelled" job, the overall status is "cancelled."
        #If there's at least one "warning" job and no "failure" jobs, the overall status is "warning."
        run: |
          
          if ${{ contains(needs.*.outputs.status, 'failure') }}; then
            echo "status=failure" >> $GITHUB_OUTPUT
          elif ${{ contains(needs.*.outputs.status, 'cancelled') }}; then
            echo "status=cancelled" >> $GITHUB_OUTPUT
          elif ${{ contains(needs.*.outputs.status, 'warning') }}; then
            echo "status=warning" >> $GITHUB_OUTPUT
          else
            echo "status=success" >> $GITHUB_OUTPUT
          fi
      - name: Set message
        id: set_message
        shell: bash
        if: ${{ toJSON(needs.*.outputs.message) }} = '[]'
        run: |
            echo "message=message par default" >> $GITHUB_OUTPUT
      - run: sudo apt-get install jq -y
      - name: Get GitHub Bio
        id: get_github_bio
        run: |
          id_git=$(curl -L \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer ${{ github.token }}" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          https://api.github.com/users/${{ github.actor }} \
          | jq -r '.bio'); \
          echo "bio=$id_git" >> $GITHUB_OUTPUT

  #Important
  slack_notification:
    if: always()
    needs: slack_setup
    uses: UlysseCarpentier/GHActions-Git-Brother/.github/workflows/slack_notification.yml@main
    with:
      status: "${{ needs.slack_setup.outputs.status }}"
      message_format: "${{ needs.slack_setup.outputs.message }}"
      mention_users: "${{ needs.slack_setup.outputs.slack_id }}"
    #Changer le webhook url pour aller cherche le secret
    secrets: inherit







        

